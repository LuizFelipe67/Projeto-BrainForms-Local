<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avatar - BrainForms</title>

<style>
/* Estiliza o corpo da página */
body {
    font-family: 'Roboto', sans-serif;
    background-color: #775085;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding-bottom: 200px;
    overflow-y: auto;
}

/* LOGO E TEXTO NO CANTO SUPERIOR ESQUERDO DO FUNDO */
.background-logo-container {
  position: absolute;
  top: 20px;
  left: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  z-index: 0;
}

.background-logo-container img {
  width: 100px;
  height: auto;
}

.background-logo-container span {
  color: white;
  font-size: 48px;
  font-weight: bold;
  font-family: 'Roboto', sans-serif;
}

/* Container principal */
.menu-container {
 background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(34, 2, 45, 0.6);
    text-align: center;
    top: 120px;
    width: 400px;
    height: 600px;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

/* Cabeçalho */
 .header-container {
      display: flex; /* Alinha logo e texto horizontalmente */
      align-items: center; /* Alinha verticalmente */
      background: linear-gradient(to bottom, #000000 0%, #3A024E 80%);
      padding: 15px 20px;
      border-radius: 12px 12px 0 0;
      color: white;
      width: 100%;
      margin-bottom: 10px;
  }

  /* Estilo da imagem do logo */
  .header-container img {
      width: 65px;
      margin-right: 10px;
  }

  /* Estilo do texto no cabeçalho */
  .header-container h3 {
      margin: 0;
      font-size: 20px;
  }

  /* Link no h3 do cabeçalho */
  .header-container h3 a {
      text-decoration: none;
      color: white;
  }

.header-left {
    display: flex;
    align-items: center;
    
}



/* Seção abaixo do cabeçalho */
.header-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 15px;
}

/* Botões (upload e voltar)
   Separo estilos comuns e específicos para permitir personalizar o botão "voltar"
   sem afetar o botão de upload. */
.icon-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  text-decoration: none;
  color: black;
}

/* upload mantém o tamanho original e fica em coluna (imagem acima do texto) */
.upload-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  text-decoration: none;
  color: black;
  font-size: 12px;
}

.upload-btn img{
  width: 40px;
  height: 40px;
  margin-bottom: 6px; /* espaço claro entre imagem e label */
}

.upload-btn span {
  font-size: 12px;
  background-color: #e2e2e2;
  padding: 3px 5px;
  border-radius: 8px;
  box-shadow: #615f5f 0px 4px 4px 0px;
}

/* botão de voltar: estilo único e um pouco maior */
.back-btn {
  display: flex; /* garante alinhamento vertical se quiser adicionar ícone depois */
  flex-direction: column;
  align-items: center;
  font-size: 14px; /* controla texto/label */
  padding: 4px 6px; /* aumenta a área clicável */
  color: black; /* sobrescreve cor de link padrão (azul) */
  text-decoration: none;
}

.back-btn span {
  font-size: 14px;
  background-color: #e2e2e2;
  padding: 12px 10px; /* maior que o upload */
  border-radius: 16px;
  box-shadow: #615f5f 0px 4px 4px 0px;
  display: inline-block;
}

/* Input escondido */
#uploadInput {
    display: none;
}

h2 {
    text-align: left;
    color: #5E097E;
    font-size: 18px;
    flex-grow: 1;
    margin-left: 5px;
}

/* Rodapé */
.footer {
    align-items: center;
    justify-content: flex-start;
    margin-top: auto;
    display: flex;
    height: 80px;
}

.footer img {
  margin-top: 80px;
    width: 65px;
    height: 60px;
    padding: 25px;
}

/* Seção do avatar */
.avatar-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
}

/* Avatar principal */
.main-avatar {
    margin-top: -4.5px;
    width: 110px;
    height: 110px;
    border-radius: 50%;
    object-fit: cover;
    box-sizing: border-box;
    border: 3px solid transparent;
    box-shadow: #615f5f 1px 5px 5px 1px;
    cursor: pointer;
    transition: transform 0.3s ease;

    background: 
      linear-gradient(white, white) padding-box, 
      linear-gradient(180deg, #00f7ff 0%, #6a00ff 35%, #f82dff 100%) border-box;

    background-origin: border-box;
}




.user-name {
    margin-top: 8px;
    font-size: 18px;
    font-weight: bold;
    color: #5E097E;
    text-align: center;
    margin-bottom: 50px;
}

/* Container para alinhar h4 e botão info lado a lado */
.header-avatar-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-top: -25px;
    margin-bottom: 10px;
}

h4 {
    margin-top: 30px;
    color: black;
    font-size: 14px;
    margin-bottom: 0;
}



/* Painel de fundo */
.avatar-panel {
    background-color: #814597;
    padding: 15px;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Avatares de escolha */
.avatar-options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
    justify-items: center;
}

.avatar-options img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #a476b4;
    border: 2px solid #3b0250;
    cursor: pointer;
    object-fit: cover;
    transition: transform 0.2s ease-in-out;
    overflow: hidden; 
    box-sizing: border-box;
}

.avatar-options img:hover {
    transform: scale(1.08);
}

@media (max-width: 480px) {
    body {
        margin: 0;
        bottom: 0;
        padding-bottom: 0;
        flex-direction: column;
    }

    .background-logo-container {
        display: none;
    }

    .menu-container {
        top: -1px;
        position: relative;
        margin: 0 auto;
        width: 95%;
        height: 98vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-sizing: border-box;
        overflow-y: hidden;
        overflow-x: hidden;
    }

    .avatar-options {
        overflow-y: auto;
        max-height: 50vh;
        padding: 10px;
    }

    .avatar-options img {
        width: 50px;
        height: 50px;
    }

    .user-name {
        font-size: 14px;
    }

    .main-avatar {
        width: 90px;
        height: 90px;
    }

    .menu-container button {
        margin-top: 50px;
    }

    .content h2 {
        margin-top: 30px;
        margin-bottom: 40px;
    }

    .content .title-box img {
        margin-top: -15px;
        width: 65px;
    }

    .content a {
        margin-top: 5px;
        height: 60px;
    }

    /* Footer - botão início à esquerda, ícone menor e texto visível, footer abaixado */
    .footer {
        position: relative;
        margin-top: -20px;  /* abaixado mais */
        padding-bottom: 10px; /* menos espaço inferior */
        display: flex;
        justify-content: flex-start; /* botão à esquerda */
        align-items: flex-end; /* alinha ícone e texto */
    }

    .footer a {
        display: flex;
        flex-direction: column; /* ícone em cima, texto embaixo */
        align-items: center;
        text-decoration: none;
        color: #fff; /* cor do texto */
        font-size: 12px; /* tamanho do texto */
        margin-right: 15px; /* espaçamento entre botões */
    }

    .footer a img {
        width: 50px;   /* tamanho do ícone */
        height: 50px;  /* tamanho do ícone */
        display: block;
        margin-bottom: 5px; /* espaço entre ícone e texto */
    }
}

   @media (min-width: 1440px) {
       .background-logo-container img {
        width: 150px;
        height: auto;
        }

        .background-logo-container span {
        font-size: 58px;

        }

      .menu-container {
        top: 5px;
        width: 500px;
        height: 700px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding-bottom: 0;
        position: relative;
        transform: translateX(-1px); /*GARANTE CENTRALIZAÇÃO IGUAL LOGIN*/
      }

            /* Estilo da imagem do logo no cabeçalho */
        .header-container img {
            width: 75px; /* Largura da imagem */
            margin-right: 15px; /* Espaço à direita da imagem */
        }

        /* Estilo do título dentro do cabeçalho */
        .header-container h3 {
            font-size: 24px; /* Tamanho da fonte menor */
        }

      h2 {
        font-size: 26px;
      }

      .back-btn span {
        font-size: 14px;
        padding: 12px 14px; ;
      }

      .back-btn:hover{
         transform: scale(1.05);
      }

      .upload-btn img{
        width: 50px;
        height: 50px;
      }

      .upload-btn span {
        font-size: 12px;
        padding: 5px 8px;
      }

      #mainAvatar {
        margin-top: -8px;
        width: 140px;
        height: 140px;
      }

    

       .user-name {
        margin-top: 10px;
        font-size: 20px;
      }

      h4{
        font-size: 16px;
      }

 

      .avatar-options {
          gap: 35px;
      }

      .avatar-options img {
          width: 75px;
          height: 75px;
      }

    

    .footer img {
        width: 70px; /* Largura aumentada */
        height: 65px; /* Altura aumentada */
        padding: 25px; /* Remove padding para não cortar imagens */
    }

}


</style>
</head>
<body>

  <!-- LOGO E TEXTO NO BACKGROUND -->
  <div class="background-logo-container">
    <img src="Imagens/Logo sem Fundo.png" alt="Logo BrainForms Fundo">
    <span>BrainForms</span>
  </div>

  <!-- Container principal -->
  <div class="menu-container">
    
    <!-- Cabeçalho -->
    <div class="header-container">
      <div class="header-left">
        <img src="Imagens/Logo sem Fundo.png" alt="Logo BrainForms">
       <h3><a href="inicio.html">BrainForms</a></h3>
      </div>
    </div>

    <!-- Linha com botão voltar, título e upload -->
    <div class="header-section">
      <a href="javascript:history.back()" class="back-btn">
        <span>&#10094; Voltar</span>
      </a>

      <h2>Alterar Foto do Perfil</h2>

      <label class="upload-btn" for="uploadInput">
        <img src="Imagens/foto.png" alt="Upload Foto">
        <span>Insira sua foto</span>
      </label>
      <input type="file" id="uploadInput" accept="image/*">
    </div>

    <!-- Seção de avatares -->
    <div class="avatar-section">
      <!-- Avatar principal -->
      <img id="mainAvatar" src="Imagens/perfilDefault.png" alt="Avatar Principal" class="main-avatar">
      
      <!-- Nome do usuário -->
      <p id="nome-usuario-avatar" class="user-name"></p>

      <!-- Container com h4 e botão info -->
      <div class="header-avatar-section">
        <h4>Escolha o avatar de sua preferência:</h4>
        
        <div class="direita">
          <button class="info-btn"
            data-info="Aqui você pode escolher um avatar para o 
            seu perfil. Clique em qualquer imagem para 
            selecioná-la ou faça upload de sua própria foto usando o botão 'Insira sua foto' no topo."
            onclick="showInfo(this)">
            <img src="Imagens/info.png" alt="Informação">
          </button>
        </div>
      </div>

      <!-- Painel com avatares -->
      <div class="avatar-panel">
        <div class="avatar-options">
          <img src="Imagens/avatar1.png" alt="Avatar 1" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar2.png" alt="Avatar 2" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar3.png" alt="Avatar 3" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar4.png" alt="Avatar 4" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar5.png" alt="Avatar 5" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar6.png" alt="Avatar 6" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar7.png" alt="Avatar 7" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar8.png" alt="Avatar 8" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar9.png" alt="Avatar 9" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar10.png" alt="Avatar 10" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar11.png" alt="Avatar 11" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar12.png" alt="Avatar 12" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar13.png" alt="Avatar 13" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar14.png" alt="Avatar 14" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar15.png" alt="Avatar 15" onclick="trocarAvatar(this.src)">
          <img src="Imagens/avatar16.png" alt="Avatar 16" onclick="trocarAvatar(this.src)">
        </div>
      </div>
    </div>

    

    <!-- Rodapé -->
    <div class="footer">
      <a href="inicio.html">
        <img src="Imagens/inicio.png" alt="Início">
      </a>
    </div>
  </div>

<script src="js/info-button.js"></script>
<script src="js/conquistas-utils.js"></script>
<script>
// Busca token do sessionStorage
const token = sessionStorage.getItem("token");

// === TROCAR AVATAR DE GALERIA ===
async function trocarAvatar(src) {
  if (!token) {
    alert("Você precisa estar logado para alterar o avatar.");
    window.location.href = "login.html";
    return;
  }

  document.getElementById('mainAvatar').src = src;
  
  // Salva avatar da galeria no banco de dados via API
  try {
    const response = await fetch("http://localhost:8000/api/avatar/update", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
        "Accept": "application/json",
      },
      body: JSON.stringify({ avatar_url: src })
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ message: "Erro ao conectar com o servidor" }));
      throw new Error(errorData.message || `Erro ${response.status}`);
    }

    const data = await response.json();
    console.log("✅ Avatar da galeria salvo no banco:", data);
    
    // Salva no sessionStorage para usar em outras páginas
    sessionStorage.setItem("alunoAvatar", src);
    
    // Verifica e mostra conquistas desbloqueadas
    const conquistas = await carregarConquistasAPI();
    if (conquistas.length > 0) {
      mostrarNovasConquistasLocal(conquistas, false, [7]);
    }
    
  } catch (err) {
    console.error("❌ Erro ao salvar avatar:", err);
    alert(`Erro ao salvar avatar: ${err.message}\n\nVerifique se o servidor Laravel está rodando em http://localhost:8000`);
  }
}

// === UPLOAD DE IMAGEM PERSONALIZADA ===
document.getElementById("uploadInput").addEventListener("change", async function(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (!token) {
    alert("Você precisa estar logado para fazer upload de avatar.");
    window.location.href = "login.html";
    return;
  }

  // Valida tamanho do arquivo (max 5MB)
  if (file.size > 5120 * 1024) {
    alert("A imagem deve ter no máximo 5MB");
    return;
  }

  // Valida tipo do arquivo
  if (!['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'].includes(file.type)) {
    alert("Por favor, selecione uma imagem JPG, PNG, GIF ou WebP");
    return;
  }

  // Valida dimensões da imagem (max 4096x4096)
  const img = new Image();
  const reader = new FileReader();
  
  reader.onload = function(e) {
    img.src = e.target.result;
    img.onload = async function() {
      if (this.width > 4096 || this.height > 4096) {
        alert(`A imagem deve ter no máximo 4096x4096 pixels.\nSua imagem: ${this.width}x${this.height} pixels`);
        return;
      }
      
      // Se passou nas validações, faz o upload
      await uploadAvatar(file);
    };
  };
  
  reader.readAsDataURL(file);
});

// Função auxiliar para fazer o upload
async function uploadAvatar(file) {
  const formData = new FormData();
  formData.append("avatar", file);

  try {
    const response = await fetch("http://localhost:8000/api/avatar/update", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Accept": "application/json",
      },
      body: formData,
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ message: "Erro ao conectar com o servidor" }));
      throw new Error(errorData.message || `Erro ${response.status}`);
    }

    const data = await response.json();
    document.getElementById("mainAvatar").src = data.avatar_url;
    
    // Salva no sessionStorage para usar em outras páginas
    sessionStorage.setItem("alunoAvatar", data.avatar_url);
    
    // Verifica e mostra conquistas desbloqueadas
    const conquistas = await carregarConquistasAPI();
    if (conquistas.length > 0) {
      mostrarNovasConquistasLocal(conquistas, false, [7]);
    }
    
    alert("✅ Avatar personalizado salvo com sucesso!");
    console.log("✅ Avatar personalizado salvo:", data);
    
  } catch (error) {
    console.error("❌ Erro no upload:", error);
    alert(`Erro ao fazer upload do avatar: ${error.message}\n\nVerifique se o servidor Laravel está rodando em http://localhost:8000`);
  }
}

// === CARREGAR NOME E AVATAR AO ENTRAR NA PÁGINA ===
document.addEventListener("DOMContentLoaded", async () => {
  // Carrega o nome do usuário do sessionStorage
  const nome = sessionStorage.getItem("alunoNome") || "Usuário";
  document.getElementById("nome-usuario-avatar").textContent = nome;

  console.log("🔑 Token encontrado:", token ? "Sim" : "Não");
  console.log("👤 Nome do usuário:", nome);

  // Se não houver token, avisa mas não redireciona imediatamente
  if (!token) {
    console.warn("⚠️ Token não encontrado no sessionStorage");
    // Usuário verá o alerta ao tentar trocar avatar
    return;
  }

  // Busca avatar do banco de dados
  try {
    const response = await fetch("http://localhost:8000/api/avatar/show", {
      headers: { 
        "Authorization": `Bearer ${token}`,
        "Accept": "application/json",
      },
    });

    if (response.ok) {
      const data = await response.json();
      if (data.avatar_url) {
        document.getElementById("mainAvatar").src = data.avatar_url;
        // Salva no sessionStorage para usar em outras páginas
        sessionStorage.setItem("alunoAvatar", data.avatar_url);
        console.log("✅ Avatar carregado do banco:", data.avatar_url);
      } else {
        console.log("ℹ️ Nenhum avatar salvo, usando padrão");
      }
    } else if (response.status === 401) {
      console.warn("⚠️ Token inválido ou expirado");
      alert("Sua sessão expirou. Faça login novamente.");
      window.location.href = "login.html";
    } else {
      console.warn("⚠️ Não foi possível carregar o avatar do servidor");
    }
  } catch (error) {
    console.error("❌ Erro ao carregar avatar:", error);
    console.warn("⚠️ Servidor não está respondendo. Verifique se o Laravel está rodando.");
    // Mantém avatar padrão se houver erro de conexão
  }
});
</script>

</body>
</html>
